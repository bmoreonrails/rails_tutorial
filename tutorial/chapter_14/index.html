<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    
      <base target="_blank"/>
    
    <title>B'more on Rails Workshop for Women</title>
    <link href="/rails_tutorial/css/syntax/monokai.css" type="text/css" rel="stylesheet"/>
    <link href="/rails_tutorial/css/base.css" type="text/css" rel="stylesheet"/>
    <link href="/rails_tutorial/assets/vendor/css/featherlight.min.css" type="text/css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="/rails_tutorial/js/jquery.min.js"></script>
    <script src="/rails_tutorial/assets/vendor/js/featherlight.min.js"></script>
    <script src="/rails_tutorial/js/tutorial_nav.js"></script>
    <script src="/rails_tutorial/js/progress.js"></script>
  </head>

<body>
  <div class="container" data-chapter="14">
    <nav>
      
<div class="tutorial_nav">
  <div class="progress"><div class="progress_bar"></div></div>
  <ul id="menu-list">
    
     <li>
      <a href="/rails_tutorial/tutorial/chapter_01/" target="_self">
        1 Getting Started from Scratch
       </a>
     </li>
    
     <li>
      <a href="/rails_tutorial/tutorial/chapter_02/" target="_self">
        2 Creating the First Table in Your Database
       </a>
     </li>
    
     <li>
      <a href="/rails_tutorial/tutorial/chapter_03/" target="_self">
        3 Viewing Data in the Browser
       </a>
     </li>
    
     <li>
      <a href="/rails_tutorial/tutorial/chapter_04/" target="_self">
        4 Showing Detailed Information in the Browser
       </a>
     </li>
    
     <li>
      <a href="/rails_tutorial/tutorial/chapter_05/" target="_self">
        5 Creating Books Through the Browser
       </a>
     </li>
    
     <li>
      <a href="/rails_tutorial/tutorial/chapter_06/" target="_self">
        6 Updating Books
       </a>
     </li>
    
     <li>
      <a href="/rails_tutorial/tutorial/chapter_07/" target="_self">
        7 Styling Your Bookstore
       </a>
     </li>
    
     <li>
      <a href="/rails_tutorial/tutorial/chapter_08/" target="_self">
        8 Deleting a Book
       </a>
     </li>
    
     <li>
      <a href="/rails_tutorial/tutorial/chapter_09/" target="_self">
        9 Reviewing a Book
       </a>
     </li>
    
     <li>
      <a href="/rails_tutorial/tutorial/chapter_10/" target="_self">
        10 Showing Reviews
       </a>
     </li>
    
     <li>
      <a href="/rails_tutorial/tutorial/chapter_11/" target="_self">
        11 Adding Reviews from the Browser
       </a>
     </li>
    
     <li>
      <a href="/rails_tutorial/tutorial/chapter_12/" target="_self">
        12 Adding Users to Your Database
       </a>
     </li>
    
     <li>
      <a href="/rails_tutorial/tutorial/chapter_13/" target="_self">
        13 Logging In and Logging Out
       </a>
     </li>
    
     <li>
      <a href="/rails_tutorial/tutorial/chapter_14/" target="_self">
        14 Logged In vs Logged Out Users
       </a>
     </li>
    
     <li>
      <a href="/rails_tutorial/tutorial/chapter_15/" target="_self">
        15 Associating Reviews with Users
       </a>
     </li>
    
     <li>
      <a href="/rails_tutorial/tutorial/chapter_16/" target="_self">
        16 The End!
       </a>
     </li>
    
   </ul>

  <div class="menu-container">
    <div class="menu" data-toggle="#menu-list">
      <div class="hamburger-icon"> &#9776</div>
      <div class="menu-title">Chapter 14 -- Logged In vs Logged Out Users</div>
      <div class="menu-title"><a href="/rails_tutorial/" target="_self">Home</a></div>
    </div>

    <div class="search">
      <form action="/rails_tutorial/search" method="get" target="_self">
        <i class="material-icons">search</i><input type="text" id="search-box" name="query">
      </form>
    </div>
  </div>

</div>

    </nav>
    <div class="content">
      <div class="sectionheader">
<p>Logged In vs Logged Out Users</p>
</div>

<div class="aside">
<p>You‚Äôre logged out, but isn‚Äôt it a little weird that you still see the ‚ÄúLog Out‚Äù link?</p>

<p><img src="/rails_tutorial/assets/images/log_out_still.png" alt="Browser showing bookstore after logging out. The &quot;Log Out&quot; link is still on the page." class="screenshot" /></p>

<p>Let‚Äôs change that! We‚Äôll only show the ‚ÄúLog Out‚Äù link to users who are logged in.</p>
</div>

<div class="aside">
<h3 id="how-do-we-know-if-a-user-is-logged-in-or-not">How Do We Know If a User is Logged In or Not?</h3>

<p>If we only want to show the ‚ÄúLog Out‚Äù link to <em>logged in</em> users, we first have to figure out if a user is logged in or not. Fortunately, we already have the parts in place to figure this out.</p>

<p>After a user successfully logs in, you‚Äôre saving their user id in the session. You did this in the <code class="highlighter-rouge">SessionsController</code> <code class="highlighter-rouge">create</code> method.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">username: </span><span class="n">params</span><span class="p">[</span><span class="ss">:session</span><span class="p">][</span><span class="ss">:username</span><span class="p">])</span>

  <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="p">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:session</span><span class="p">][</span><span class="ss">:password</span><span class="p">])</span>
    <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
    <span class="nf">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">id</span>
    <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">else</span>
    <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>When a user logs out, you remove their user id from the session. You did this in the <code class="highlighter-rouge">SessionsController</code> <code class="highlighter-rouge">destroy</code> method.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">destroy</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</code></pre>
</div>

<p>We can tell if a user is logged in or not by checking in the session. If a user id is present, we know that user is logged in. Otherwise, no one is logged in.</p>

<p>We‚Äôve only used the session in your controllers, but it‚Äôs also avaialble in your templates. Let‚Äôs see what we can do with it.</p>

<p>Before we get to far, you‚Äôll need to log in again.</p>
</div>

<div class="steps">
<div class="list">
<ol>
  <li>
    <p>Open Terminal and go to the <code class="highlighter-rouge">bookstore</code> directory.</p>
  </li>
  <li>
    <p>Now, start you application‚Äôs web server.</p>
  </li>
  <li>
    <p>Go to <a href="http://localhost:3000/session/new">http://localhost:3000/session/new</a> and log in as ‚ÄúCatPower‚Äù with password ‚Äúpassword‚Äù.</p>
  </li>
</ol>
</div>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">  ‚Ä∫ <span class="nb">pwd</span>
  /Users/alimi/Projects/bookstore

  ‚Ä∫ rails server
  <span class="o">=</span>&gt; Booting Puma
  <span class="o">=</span>&gt; Rails 5.0.0.1 application starting <span class="k">in </span>development on http://localhost:3000</code></pre></figure>

</div>

<p><img src="/rails_tutorial/assets/images/welcome_back_cat_power.png" alt="Browser showing homepage with &quot;Welcome back, CatPower!&quot; login message" class="screenshot" /></p>

<div class="steps">
<div class="list">
<p>Now that you‚Äôre logged in, we can start making some changes üòä</p>

<ol>
  <li>
    <p>Open <code class="highlighter-rouge">app/views/layouts/application.html.erb</code>.</p>
  </li>
  <li>
    <p>Above the ‚ÄúLog Out‚Äù link, add the following line:</p>

    <div class="language-erb highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;p&gt;</span> Hi, my user id is <span class="cp">&lt;%=</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/p&gt;</span>
</code></pre>
    </div>

    <p>The same session hash you used in the <code class="highlighter-rouge">SessionsController</code> is also available here in this template.</p>

    <p>With this change, you‚Äôre going to show what user id is saved in the session. Since you‚Äôre logged in as ‚ÄúCatPower‚Äù, it‚Äôs going to show CatPower‚Äôs user id.</p>
  </li>
  <li>
    <p>Save your changes and revist <a href="http://localhost:3000">http://localhost:3000</a>.</p>
  </li>
</ol>
</div>

<figure class="highlight"><pre><code class="language-erb" data-lang="erb"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></td><td class="code"><pre>  <span class="cp">&lt;!DOCTYPE html&gt;</span>
  <span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
      <span class="nt">&lt;title&gt;</span>Bookstore<span class="nt">&lt;/title&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media: </span><span class="s1">'all'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span><span class="p">:</span> <span class="s1">'reload'</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span><span class="p">:</span> <span class="s1">'reload'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/head&gt;</span>

    <span class="nt">&lt;body&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"left"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"center"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"My Super Rad Bookstore"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"right"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;p&gt;</span> Hi, my user id is <span class="cp">&lt;%=</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/p&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log Out"</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="ss">method: :delete</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>

      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"notice"</span><span class="nt">&gt;</span> <span class="cp">&lt;%=</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/p&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:alert</span><span class="p">]</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"alert"</span><span class="nt">&gt;</span> <span class="cp">&lt;%=</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:alert</span><span class="p">]</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/p&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
  <span class="nt">&lt;/html&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

</div>

<p><img src="/rails_tutorial/assets/images/hi_my_user_id.png" alt="Browser showing &quot;Hi, my user id is 1&quot; above the &quot;Log Out&quot; link" class="screenshot" /></p>

<div class="steps">
<div class="list">
<p>Sweet! Now that we know how to access the session in your templates, let‚Äôs put it to use.</p>

<ol>
  <li>
    <p>Reopen <code class="highlighter-rouge">app/views/layouts/application.html.erb</code>.</p>
  </li>
  <li>
    <p>Change the ‚ÄúLog Out‚Äù link and its parent <code class="highlighter-rouge">div</code> from</p>

    <div class="language-erb highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"right"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;p&gt;</span> Hi, my user id is <span class="cp">&lt;%=</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/p&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log Out"</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="ss">method: :delete</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
    </div>

    <p>to</p>

    <div class="language-erb highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"right"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log Out"</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="ss">method: :delete</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
    I'm not logged in
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
    </div>

    <p>If a <code class="highlighter-rouge">user_id</code> is set in the session, we‚Äôll show the ‚ÄúLog Out‚Äù link. Otherwise, we‚Äôll just show ‚ÄúI‚Äôm not logged in‚Äù.</p>
  </li>
  <li>
    <p>Save your changes and revisit <a href="http://localhost:3000">http://localhost:3000</a>. Log out and you should no longer see the ‚ÄúLog Out‚Äù link.</p>
  </li>
</ol>
</div>

<figure class="highlight"><pre><code class="language-erb" data-lang="erb"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></td><td class="code"><pre>  <span class="cp">&lt;!DOCTYPE html&gt;</span>
  <span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
      <span class="nt">&lt;title&gt;</span>Bookstore<span class="nt">&lt;/title&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media: </span><span class="s1">'all'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span><span class="p">:</span> <span class="s1">'reload'</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span><span class="p">:</span> <span class="s1">'reload'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/head&gt;</span>

    <span class="nt">&lt;body&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"left"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"center"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"My Super Rad Bookstore"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"right"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log Out"</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="ss">method: :delete</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            I'm not logged in
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>

      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"notice"</span><span class="nt">&gt;</span> <span class="cp">&lt;%=</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/p&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:alert</span><span class="p">]</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"alert"</span><span class="nt">&gt;</span> <span class="cp">&lt;%=</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:alert</span><span class="p">]</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/p&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
  <span class="nt">&lt;/html&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

</div>

<p><img src="/rails_tutorial/assets/images/yay_logout_button.png" alt="Browser showing &quot;I'm not logged in&quot;" class="screenshot" /></p>

<div class="aside">
<p>Progress!</p>

<p>Now that we aren‚Äôt showing the ‚ÄúLog Out‚Äù link to logged out users, let‚Äôs show them a ‚ÄúLogin‚Äù link instead.</p>
</div>

<div class="steps">
<div class="list">
<ol>
  <li>
    <p>In <code class="highlighter-rouge">app/views/layouts/application.html.erb</code>, replace ‚ÄúI‚Äôm not logged in‚Äù with a link labeled ‚ÄúLogin‚Äù. The link should go to the <code class="highlighter-rouge">new_session</code> path.</p>

    <p>Use the other links in the template as examples.</p>
  </li>
</ol>
</div>
</div>

<div class="steps">
<div class="list">
<ol>
  <li>
    <p>What does your link look like? It should look something like this:</p>

    <div class="language-erb highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log In"</span><span class="p">,</span> <span class="n">new_session_path</span> <span class="cp">%&gt;</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>If you didn‚Äôt already, add the ‚ÄúLog In‚Äù link. Save your changes, revist <a href="http://localhost:3000">http://localhost:3000</a>, and try logging in!</p>
  </li>
</ol>
</div>

<figure class="highlight"><pre><code class="language-erb" data-lang="erb"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></td><td class="code"><pre>  <span class="cp">&lt;!DOCTYPE html&gt;</span>
  <span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
      <span class="nt">&lt;title&gt;</span>Bookstore<span class="nt">&lt;/title&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media: </span><span class="s1">'all'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span><span class="p">:</span> <span class="s1">'reload'</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span><span class="p">:</span> <span class="s1">'reload'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/head&gt;</span>

    <span class="nt">&lt;body&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"left"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"center"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"My Super Rad Bookstore"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"right"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log Out"</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="ss">method: :delete</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log In"</span><span class="p">,</span> <span class="n">new_session_path</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>

      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"notice"</span><span class="nt">&gt;</span> <span class="cp">&lt;%=</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/p&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:alert</span><span class="p">]</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"alert"</span><span class="nt">&gt;</span> <span class="cp">&lt;%=</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:alert</span><span class="p">]</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/p&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
  <span class="nt">&lt;/html&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

</div>

<p><img src="/rails_tutorial/assets/images/login_link.png" alt="Browser showing &quot;Log In&quot; link" class="screenshot" /></p>

<div class="aside">
<p>If you‚Äôre anything like me, you probably tried to log out just as soon as you logged in so you could see the link change back and forth.</p>

<p><img src="/rails_tutorial/assets/images/Yes-No-Not-Really-GIF.gif" alt="Sure I did" /></p>

<p>But if you‚Äôre not like me, give it a try! You‚Äôve got to appreciate the small things in life üòù</p>

<p>You might also notice that the ‚ÄúLog Out‚Äù/‚ÄùLogin‚Äù links are on every page of your bookstore.</p>

<p><code class="highlighter-rouge">app/views/layouts/application.html.erb</code> is the main layout file of your application, and it‚Äôs used by every template in your bookstore. Since we added the links to this layout, they will get rendered on every page.</p>
</div>

<div class="steps">
<div class="list">
<p>Now that we have logged in and logged out users, can you think of things logged out users shouldn‚Äôt be able to do?</p>

<p>I can think of one - logged out users shouldn‚Äôt be able to add books. This is <em>your</em> super rad bookstore after all. You don‚Äôt want some random person to come along and start adding books to your bookstore.</p>

<ol>
  <li>
    <p>Open <code class="highlighter-rouge">app/views/books/index.html.erb</code> and find the ‚ÄúAdd a book‚Äù link.</p>

    <p>Take some time and try updating the template so the ‚ÄúAdd a book‚Äù link is only visible to logged in users. Logged out users shouldn‚Äôt see anything.</p>
  </li>
</ol>
</div>
</div>

<div class="steps">
<div class="list">
<ol>
  <li>
    <p>What does your solution look like? It should look a lot like the code you used to show the ‚ÄúLog Out‚Äù link.</p>

    <div class="language-erb highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Add a book"</span><span class="p">,</span> <span class="n">new_book_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"button"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
    </div>

    <p>The difference here is we don‚Äôt have an <code class="highlighter-rouge">else</code> statement. Before, we wanted to show a ‚ÄúLogin‚Äù link to logged out users.</p>

    <div class="language-erb highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log Out"</span><span class="p">,</span> <span class="n">session_path</span><span class="p">,</span> <span class="ss">method: :delete</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log In"</span><span class="p">,</span> <span class="n">new_session_path</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
    </div>

    <p>Now, we don‚Äôt want to show anything to logged out users. Therefore, we don‚Äôt need the <code class="highlighter-rouge">else</code> statement.</p>
  </li>
  <li>
    <p>Update your solution to match this solution and save your changes.</p>
  </li>
  <li>
    <p>Go to <a href="http://localhost:3000">http://localhost:3000</a>, and switch between being logged in and logged out.</p>

    <p>When you log out, the ‚ÄúAdd a book‚Äù link will disappear‚Ä¶</p>

    <p><img src="/rails_tutorial/assets/images/poof.gif" alt="Poof!" /></p>
  </li>
</ol>
</div>

<figure class="highlight"><pre><code class="language-erb" data-lang="erb"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre>  <span class="nt">&lt;h1&gt;</span>Welcome to My Super Rad Bookstore!<span class="nt">&lt;/h1&gt;</span>

  <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="vi">@books</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="n">book</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">book_path</span><span class="p">(</span><span class="n">book</span><span class="p">))</span> <span class="cp">%&gt;</span> by <span class="cp">&lt;%=</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>

  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Add a book"</span><span class="p">,</span> <span class="n">new_book_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"button"</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

</div>

<p><img src="/rails_tutorial/assets/images/add_book_link_gone.png" alt="Browser showing homepage without &quot;Add a book&quot; link for logged out users" class="screenshot" /></p>

<div class="steps">
<div class="list">
<p>Can you think of other things logged out users shouldn‚Äôt be able to do?</p>

<p>Right now, if you go to a book‚Äôs page, anyone can edit, review, or delete a book. I wouldn‚Äôt want to give such broad powers to anyone in <em>my</em> super rad bookstore, and you shouldn‚Äôt either!</p>

<ol>
  <li>
    <p>Open <code class="highlighter-rouge">app/views/books/show.html.erb</code>. At the end of the template, you have links to edit a book and add a review. You also have a button to delete a book.</p>

    <div class="language-erb highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Edit book"</span><span class="p">,</span> <span class="n">edit_book_path</span><span class="p">(</span><span class="vi">@book</span><span class="p">),</span> <span class="ss">class: </span><span class="s2">"button"</span><span class="p">)</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Add a Review"</span><span class="p">,</span> <span class="n">new_book_review_path</span><span class="p">(</span><span class="vi">@book</span><span class="p">),</span> <span class="ss">class: </span><span class="s2">"button"</span><span class="p">)</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">button_to</span><span class="p">(</span><span class="s2">"Delete Book"</span><span class="p">,</span> <span class="n">book_path</span><span class="p">(</span><span class="vi">@book</span><span class="p">),</span> <span class="ss">method: :delete</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"button danger"</span><span class="p">)</span> <span class="cp">%&gt;</span>
</code></pre>
    </div>

    <p>Update the template so the links and button are only available to logged in users.</p>
  </li>
</ol>
</div>
</div>

<div class="steps">
<div class="list">
<ol>
  <li>
    <p>What did you come up with? Maybe you did something like this:</p>

    <div class="language-erb highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Edit book"</span><span class="p">,</span> <span class="n">edit_book_path</span><span class="p">(</span><span class="vi">@book</span><span class="p">),</span> <span class="ss">class: </span><span class="s2">"button"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Add a Review"</span><span class="p">,</span> <span class="n">new_book_review_path</span><span class="p">(</span><span class="vi">@book</span><span class="p">),</span> <span class="ss">class: </span><span class="s2">"button"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">button_to</span><span class="p">(</span><span class="s2">"Delete Book"</span><span class="p">,</span> <span class="n">book_path</span><span class="p">(</span><span class="vi">@book</span><span class="p">),</span> <span class="ss">method: :delete</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"button danger"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
    </div>

    <p>This works really well, but doesn‚Äôt it feel a little repetitive? We‚Äôre using the same condition for all three elements to decide if they should be rendered or not.</p>

    <p>You can simplify things a bit with something like this:</p>

    <div class="language-erb highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Edit book"</span><span class="p">,</span> <span class="n">edit_book_path</span><span class="p">(</span><span class="vi">@book</span><span class="p">),</span> <span class="ss">class: </span><span class="s2">"button"</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Add a Review"</span><span class="p">,</span> <span class="n">new_book_review_path</span><span class="p">(</span><span class="vi">@book</span><span class="p">),</span> <span class="ss">class: </span><span class="s2">"button"</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">button_to</span><span class="p">(</span><span class="s2">"Delete Book"</span><span class="p">,</span> <span class="n">book_path</span><span class="p">(</span><span class="vi">@book</span><span class="p">),</span> <span class="ss">method: :delete</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"button danger"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>If you don‚Äôt have a similar solution, update your solution to match the last solution.</p>
  </li>
  <li>
    <p>Save your changes and check out the book details page as a logged in and logged out user.</p>
  </li>
</ol>
</div>

<figure class="highlight"><pre><code class="language-erb" data-lang="erb"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></td><td class="code"><pre>  <span class="nt">&lt;dl&gt;</span>
    <span class="nt">&lt;dt&gt;</span>Id<span class="nt">&lt;/dt&gt;</span>
    <span class="nt">&lt;dd&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/dd&gt;</span>

    <span class="nt">&lt;dt&gt;</span>Title<span class="nt">&lt;/dt&gt;</span>
    <span class="nt">&lt;dd&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/dd&gt;</span>

    <span class="nt">&lt;dt&gt;</span>Author<span class="nt">&lt;/dt&gt;</span>
    <span class="nt">&lt;dd&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="cp">%&gt;</span><span class="nt">&lt;/dd&gt;</span>

    <span class="nt">&lt;dt&gt;</span>Price<span class="nt">&lt;/dt&gt;</span>
    <span class="nt">&lt;dd&gt;</span><span class="cp">&lt;%=</span> <span class="n">number_to_currency</span><span class="p">(</span><span class="vi">@book</span><span class="p">.</span><span class="nf">price_cents</span> <span class="o">/</span> <span class="mi">100</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/dd&gt;</span>

    <span class="nt">&lt;dt&gt;</span>Quantity<span class="nt">&lt;/dt&gt;</span>
    <span class="nt">&lt;dd&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">quantity</span> <span class="cp">%&gt;</span><span class="nt">&lt;/dd&gt;</span>

    <span class="nt">&lt;dt&gt;</span>Description<span class="nt">&lt;/dt&gt;</span>
    <span class="nt">&lt;dd&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">description</span> <span class="cp">%&gt;</span><span class="nt">&lt;/dd&gt;</span>
  <span class="nt">&lt;/dl&gt;</span>

  <span class="nt">&lt;p&gt;</span> Number of reviews: <span class="cp">&lt;%=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">reviews</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/p&gt;</span>

  <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">reviews</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">review</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span> <span class="cp">&lt;%=</span> <span class="n">review</span><span class="p">.</span><span class="nf">body</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>

  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Edit book"</span><span class="p">,</span> <span class="n">edit_book_path</span><span class="p">(</span><span class="vi">@book</span><span class="p">),</span> <span class="ss">class: </span><span class="s2">"button"</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Add a Review"</span><span class="p">,</span> <span class="n">new_book_review_path</span><span class="p">(</span><span class="vi">@book</span><span class="p">),</span> <span class="ss">class: </span><span class="s2">"button"</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">button_to</span><span class="p">(</span><span class="s2">"Delete Book"</span><span class="p">,</span> <span class="n">book_path</span><span class="p">(</span><span class="vi">@book</span><span class="p">),</span> <span class="ss">method: :delete</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"button danger"</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

</div>

<p><img src="/rails_tutorial/assets/images/hide_buttons.png" alt="Browser showing book details page without action elements" class="screenshot" /></p>

<div class="steps">
<div class="list">
<p>Alright, I think we‚Äôve hidden everything we need to hide from logged out users. Your bookstore is super secure now, right?!</p>

<p><img src="/rails_tutorial/assets/images/tenor.gif" alt="This cop thinks everything is fine" /></p>

<ol>
  <li>
    <p>Make sure you‚Äôre logged out and try going to <a href="http://localhost:3000/books/new">http://localhost:3000/books/new</a>.</p>

    <p>Anyone can add books!</p>

    <p><img src="/rails_tutorial/assets/images/no.gif" alt="No!" /></p>

    <p>We made it more difficult for logged out users to mess with your bookstore, but that won‚Äôt stop them if they can figure out the paths to go to.</p>

    <p>We can stop mischievous users from snooping around by checking for logged out users in your controllers.</p>
  </li>
</ol>
</div>
</div>

<div class="steps">
<div class="list">
<p>Let‚Äôs start by looking at the <code class="highlighter-rouge">BooksController</code> <code class="highlighter-rouge">new</code> method.</p>

<p>The session is available to us in all of our controllers. Let‚Äôs use it to check if a user is logged in. If they‚Äôre logged in, we can do what we‚Äôve always been doing. Otherwise, let‚Äôs redirect the user to the login page.</p>

<ol>
  <li>
    <p>Open <code class="highlighter-rouge">app/controllers/books_controller.rb</code>. Change the <code class="highlighter-rouge">new</code> method from</p>

    <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">new</span>
  <span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span>
<span class="k">end</span>
</code></pre>
    </div>

    <p>to</p>

    <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">new</span>
  <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">blank?</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:alert</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Please login to continue"</span>
    <span class="n">redirect_to</span> <span class="n">new_session_path</span>
  <span class="k">else</span>
    <span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
    </div>

    <p>If a user is logged in, their user id will be in the session. If their user id is not in the session, we‚Äôll add a flash message and send them to the <code class="highlighter-rouge">new_session_path</code>. Otherwise, we‚Äôll continue with the method‚Äôs previous behavior.</p>
  </li>
  <li>
    <p>Save your changes and revist <a href="http://localhost:3000/books/new">http://localhost:3000/books/new</a>. You should now be redirected to the login page.</p>
  </li>
</ol>
</div>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre></td><td class="code"><pre>  <span class="k">class</span> <span class="nc">BooksController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
    <span class="k">def</span> <span class="nf">index</span>
      <span class="vi">@books</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">all</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">show</span>
      <span class="vi">@id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span>
      <span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="vi">@id</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">new</span>
      <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">blank?</span>
        <span class="n">flash</span><span class="p">[</span><span class="ss">:alert</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Please login to continue"</span>
        <span class="n">redirect_to</span> <span class="n">new_session_path</span>
      <span class="k">else</span>
        <span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">create</span>
      <span class="no">Book</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">book_params</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">books_path</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">edit</span>
      <span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">update</span>
      <span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="n">book</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">book_params</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">book_path</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">book_params</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:book</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">:price_cents</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="ss">:description</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">destroy</span>
      <span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="n">book</span><span class="p">.</span><span class="nf">destroy</span>
      <span class="n">redirect_to</span> <span class="n">books_path</span>
    <span class="k">end</span>
  <span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

</div>

<p><img src="/rails_tutorial/assets/images/oh_no_login.png" alt="Browser showing login page with alert to login before continuing" class="screenshot" /></p>

<div class="aside">
<h3 id="adding-more-restrictions-to-the-bookscontroller">Adding More Restrictions to the BooksController</h3>

<p>Now that we have this check in place, we should probably add them to a few more of the <code class="highlighter-rouge">BooksController</code> methods.</p>

<p><code class="highlighter-rouge">index</code> and <code class="highlighter-rouge">show</code> should be available to all users, but logged out users shouldn‚Äôt have access to <code class="highlighter-rouge">create</code>, <code class="highlighter-rouge">edit</code>, <code class="highlighter-rouge">update</code>, or <code class="highlighter-rouge">destroy</code>.</p>

<p>One solution to this problem would be to copy the check we added to the <code class="highlighter-rouge">new</code> method to the rest of the methods we want to secure. This would work, but copying code is suprisingly time consuming. Fortunately, Rails has a method that will help us out.</p>
</div>

<div class="steps">
<div class="list">
<ol>
  <li>
    <p>Open the <code class="highlighter-rouge">BooksController</code>. Just after the beginning of the controller, add the following line:</p>

    <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">before_action</span> <span class="ss">:verify_user_session</span>
</code></pre>
    </div>

    <p>Before every method in the <code class="highlighter-rouge">BooksController</code>, Rails will first call <code class="highlighter-rouge">verify_user_session</code>.</p>
  </li>
  <li>
    <p>If you try to go to <a href="http://localhost:3000/books/new">http://localhost:3000/books/new</a> now, you‚Äôll get an error. Can you guess why?</p>

    <p>We haven‚Äôt defined a <code class="highlighter-rouge">verify_user_session</code> method!</p>
  </li>
  <li>
    <p>At the end of the <code class="highlighter-rouge">BooksController</code>, add the <code class="highlighter-rouge">verify_user_session</code> method:</p>

    <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">verify_user_session</span>
  <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">blank?</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:alert</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Please login to continue"</span>
    <span class="n">redirect_to</span> <span class="n">new_session_path</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
    </div>

    <p>This should look <em>very</em> familiar. It‚Äôs the same logic you used in the <code class="highlighter-rouge">new</code> method!</p>

    <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">new</span>
  <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">blank?</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:alert</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Please login to continue"</span>
    <span class="n">redirect_to</span> <span class="n">new_session_path</span>
  <span class="k">else</span>
    <span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
    </div>

    <p>Since you‚Äôre doing the check in <code class="highlighter-rouge">verify_user_session</code>, you don‚Äôt need it in the <code class="highlighter-rouge">new</code> method anymore. Remove the check so the <code class="highlighter-rouge">new</code> method is back to its old self.</p>

    <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">new</span>
  <span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span>
<span class="k">end</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>Save your changes and revisit <a href="http://localhost:3000/books/new">http://localhost:3000/books/new</a>. You should still be redirected to the login page.</p>

    <p>Try visiting another page like the edit book page. For example, if you still have your first book you can go to <a href="http://localhost:3000/books/1/edit">http://localhost:3000/books/1/edit</a>. Once again, you should be redirected to the login page.</p>
  </li>
</ol>
</div>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></td><td class="code"><pre>  <span class="k">class</span> <span class="nc">BooksController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
    <span class="n">before_action</span> <span class="ss">:verify_user_session</span>

    <span class="k">def</span> <span class="nf">index</span>
      <span class="vi">@books</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">all</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">show</span>
      <span class="vi">@id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span>
      <span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="vi">@id</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">new</span>
      <span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">create</span>
      <span class="no">Book</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">book_params</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">books_path</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">edit</span>
      <span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">update</span>
      <span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="n">book</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">book_params</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">book_path</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">book_params</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:book</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">:price_cents</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="ss">:description</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">destroy</span>
      <span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="n">book</span><span class="p">.</span><span class="nf">destroy</span>
      <span class="n">redirect_to</span> <span class="n">books_path</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">verify_user_session</span>
      <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">blank?</span>
        <span class="n">flash</span><span class="p">[</span><span class="ss">:alert</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Please login to continue"</span>
        <span class="n">redirect_to</span> <span class="n">new_session_path</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

</div>

<div class="steps">
<div class="list">
<ol>
  <li>
    <p>Now that we have all this security in place, log out and visit <a href="http://localhost:3000">http://localhost:3000</a>.</p>

    <p><img src="/rails_tutorial/assets/images/full-house-o.gif" alt="Wat" /></p>

    <p>We made the <code class="highlighter-rouge">BooksController</code> a little <em>too</em> secure üòÖ</p>

    <p>Remember, logged out users should still be able to access the <code class="highlighter-rouge">BooksController</code> <code class="highlighter-rouge">index</code> and <code class="highlighter-rouge">show</code> methods.</p>
  </li>
  <li>
    <p>Open the <code class="highlighter-rouge">BooksController</code>. After the <code class="highlighter-rouge">before_action</code>, add the following line:</p>

    <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">skip_before_action</span> <span class="ss">:verify_user_session</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:show</span><span class="p">]</span>
</code></pre>
    </div>

    <p>This tells Rails to skip the <code class="highlighter-rouge">before_action</code> that calls <code class="highlighter-rouge">verify_user_session</code> for the <code class="highlighter-rouge">index</code> and <code class="highlighter-rouge">show</code> methods.</p>
  </li>
  <li>
    <p>Save your changes and revisit <a href="http://localhost:3000">http://localhost:3000</a>.</p>

    <p>Now that you‚Äôre back in, try going directly to a book‚Äôs detail page. For example, you could go to <a href="http://localhost:3000/books/1">http://localhost:3000/books/1</a>.</p>
  </li>
  <li>
    <p>Try visiting different paths directly as logged in and logged out users. The book index and details page should be available to both, but only logged in users can reach things like the edit book page.</p>
  </li>
</ol>
</div>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></td><td class="code"><pre>  <span class="k">class</span> <span class="nc">BooksController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
    <span class="n">before_action</span> <span class="ss">:verify_user_session</span>
    <span class="n">skip_before_action</span> <span class="ss">:verify_user_session</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:show</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">index</span>
      <span class="vi">@books</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">all</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">show</span>
      <span class="vi">@id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span>
      <span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="vi">@id</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">new</span>
      <span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">create</span>
      <span class="no">Book</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">book_params</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">books_path</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">edit</span>
      <span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">update</span>
      <span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="n">book</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">book_params</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">book_path</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">book_params</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:book</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">:price_cents</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="ss">:description</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">destroy</span>
      <span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="n">book</span><span class="p">.</span><span class="nf">destroy</span>
      <span class="n">redirect_to</span> <span class="n">books_path</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">verify_user_session</span>
      <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">blank?</span>
        <span class="n">flash</span><span class="p">[</span><span class="ss">:alert</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Please login to continue"</span>
        <span class="n">redirect_to</span> <span class="n">new_session_path</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

</div>

<div class="steps">
<div class="list">
<p>Now that we have the <code class="highlighter-rouge">BooksController</code> locked down, let‚Äôs add the same checks to the <code class="highlighter-rouge">ReviewsController</code>.</p>

<ol>
  <li>
    <p>Open the <code class="highlighter-rouge">ReviewsController</code> (<code class="highlighter-rouge">app/controllers/reviews_controller.rb</code>).</p>
  </li>
  <li>
    <p>Using the <code class="highlighter-rouge">BooksController</code> as an example, add a <code class="highlighter-rouge">before_action</code> to the <code class="highlighter-rouge">ReviewsController</code> that calls <code class="highlighter-rouge">verify_user_session</code> before each of the controller‚Äôs methods.</p>

    <p><code class="highlighter-rouge">verify_user_session</code> should redirect logged out users to the <code class="highlighter-rouge">new_session</code> path so they can login.</p>
  </li>
</ol>
</div>
</div>

<div class="steps">
<div class="list">
<ol>
  <li>
    <p>How did you change the <code class="highlighter-rouge">ReviewsController</code>. The <code class="highlighter-rouge">before_action</code> line should‚Äôve been a spitting image of the <code class="highlighter-rouge">before_action</code> line from the <code class="highlighter-rouge">BooksController</code>.</p>

    <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">before_action</span> <span class="ss">:verify_user_session</span>
</code></pre>
    </div>

    <p>What about the <code class="highlighter-rouge">verify_user_session</code> method? It should also be a spitting image üòä</p>

    <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">verify_user_session</span>
  <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">blank?</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:alert</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Please login to continue"</span>
    <span class="n">redirect_to</span> <span class="n">new_session_path</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>If you didn‚Äôt already, add the <code class="highlighter-rouge">before_action</code> and the <code class="highlighter-rouge">verify_user_session</code> method to the <code class="highlighter-rouge">ReviewsController</code>.</p>
  </li>
  <li>
    <p>Save your changes and trying visting a new review page as both a logged out and logged in user. For example, you would add a new review for your first book by visiting <a href="http://localhost:3000/books/1/reviews/new">http://localhost:3000/books/1/reviews/new</a>.</p>
  </li>
  <li>
    <p>When you‚Äôre done exploring all your changes, stop your application‚Äôs web server.</p>
  </li>
</ol>
</div>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></td><td class="code"><pre>  <span class="k">class</span> <span class="nc">ReviewsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
    <span class="n">before_action</span> <span class="ss">:verify_user_session</span>

    <span class="k">def</span> <span class="nf">new</span>
      <span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:book_id</span><span class="p">])</span>
      <span class="vi">@review</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">reviews</span><span class="p">.</span><span class="nf">build</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">create</span>
      <span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:book_id</span><span class="p">])</span>
      <span class="n">book</span><span class="p">.</span><span class="nf">reviews</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">review_params</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">book_path</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">review_params</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:review</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:body</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">verify_user_session</span>
      <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">].</span><span class="nf">blank?</span>
        <span class="n">flash</span><span class="p">[</span><span class="ss">:alert</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Please login to continue"</span>
        <span class="n">redirect_to</span> <span class="n">new_session_path</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

</div>

      <div class="tutorial-button-group">
  
    
      <a href="/rails_tutorial/tutorial/chapter_13/" target="_self">
        <div class="back-button">
          Chapter 13
        </div>
      </a>
    
    
      <a href="/rails_tutorial/tutorial/chapter_15/" target="_self">
        <div class="next-button">
          Chapter 15
        </div>
      </a>
    
  
</div>

    </div>
  </div>
<footer>
  <div class="container">
    <a href="http://bmoreonrails.org/">
      <img src="/rails_tutorial/assets/icons/bmore.png">
    </a>

    <a rel="license" href="/rails_tutorial/license" target="_self">
      <img class="icon"
           alt="Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License"
           src="/rails_tutorial/assets/icons/cc-by-nc-sa.svg"
      />
    </a>

    <a href="https://github.com/bmoreonrails/rails_tutorial">
      <img class="icon"
           alt="Rails Tutorial on GitHub"
           src="/rails_tutorial/assets/icons/github.png"
      />
    </a>

    <a href="https://twitter.com/BmorRailsSchool">
      <img class="icon"
           alt="B'more on Rails School on Twitter"
           src="/rails_tutorial/assets/icons/twitter.png"
      />
    </a>
  </div>
</footer>
</body>
</html>


<script>

$('img.screenshot').featherlight({
    targetAttr: 'src'
});

</script>
